<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introduction to Python Programming - Learn to Code & Earn!</title>
    <!-- Social Icon Link -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Link to your external CSS file -->
    <link rel="stylesheet" href="static/styles.css">
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="static/images/my_logo.webp">
    <link rel="preconnect" href="https://checkout.flutterwave.com">
    <!-- Preconnect to your backend and Flutterwave API for faster loading -->
    <link rel="preconnect" href="https://osayanhu.vercel.app"> <!-- IMPORTANT: Replace with your actual deployed backend URL -->
    <link rel="preconnect" href="https://api.flutterwave.cloud"> 
    <link rel="preconnect" href="https://python-proc-713130948738.us-central1.run.app"> <!-- Preconnect for Zapier webhook -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7501475906311384"
     crossorigin="anonymous"></script>
    <!-- Meta Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '1461810711803253');
        fbq('track', 'PageView');
        </script>
        <noscript><img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1461810711803253&ev=PageView&noscript=1"
    /></noscript>
<!-- End Meta Pixel Code -->

    <!-- Styles specific to this ebook landing page AND the new modal -->
    <style>
        .ebook-landing-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 3em 80px;
            color: #ebebeb;
            text-align: center;
        }

        .ebook-image-wrapper {
            width: 100%;
            max-width: 350px;
            height: auto;
            margin-bottom: 2em;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ff0077;
            box-shadow: 0 0 20px rgba(255, 0, 119, 0.5);
            background: transparent;
        }

        .ebook-image {
            width: 100%;
            height: auto;
            display: block;
            background: transparent;
        }

        .ebook-content {
            max-width: 700px;
            margin-top: 2em;
            padding: 1.5em 2em; /* Reduced padding for more compact content */
            border-radius: 12px;
            background-color: rgba(26, 26, 26, 0.8); /* Slightly lighter dark background for content block */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            text-align: center; /* Ensure main content text is centered */
            border: 1px solid rgba(255, 0, 119, 0.2); /* Subtle border matching accent */
        }

        .ebook-content h1 {
            font-size: 2.8em; /* Impactful heading */
            color: #ff0077;
            margin-bottom: 0.8em;
            line-height: 1.2;
            background: transparent;
        }

        .ebook-content p {
            font-size: 1.1em;
            color: #ebebeb;
            line-height: 1.6;
            margin-bottom: 1.5em; /* Standard paragraph spacing */
            opacity: 0.8;
            background: transparent;
        }

        /* Call to Action Button */
        .ebook-btn {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 300px; /* Slightly wider button for prominence */
            height: 65px; /* Taller button for prominence */
            background: linear-gradient(45deg, #ff0077, #e00066); /* Gradient for pop */
            border: 2px solid #ff0077;
            border-radius: 8px;
            font-size: 22px; /* Larger font */
            color: #ffffff;
            text-decoration: none;
            letter-spacing: 1px;
            font-weight: 700;
            z-index: 1;
            overflow: hidden;
            transition: all 0.5s ease;
            margin: 2em auto 1em; /* Center button and provide spacing */
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 0, 119, 0.4); /* Stronger shadow */
            position: relative;
        }

        .ebook-btn:hover {
            transform: translateY(-3px) scale(1.02);
            background: linear-gradient(45deg, #e00066, #ff0077);
            box-shadow: 0 8px 30px rgba(255, 0, 119, 0.6);
            color: #fff;
        }

        .ebook-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.15);
            transition: all 0.5s ease;
            transform: skewX(-20deg);
            z-index: -1;
        }

        .ebook-btn:hover::before {
            left: 100%;
        }

        .secure-payment-text {
            color: #ebebeb;
            opacity: 0.6;
            font-size: 0.9em;
            margin-top: 1em;
            background: transparent;
        }

        /* Responsive adjustments */
        @media screen and (max-width: 952px) {
            .ebook-landing-container {
                padding: 3em;
            }
            .ebook-content h1 {
                font-size: 2.2em;
            }
            .ebook-content p {
                font-size: 1em;
            }
            .ebook-btn {
                width: 250px;
                height: 55px;
                font-size: 18px;
            }
            .ebook-content {
                padding: 1.2em 1.5em;
                margin: 1.5em auto;
            }
            /* Form input adjustments inside modal */
            .payment-form {
                max-width: 90%; /* Wider on smaller screens */
            }
        }

        @media screen and (max-width: 858px) {
            .ebook-landing-container {
                padding: 2em;
            }
            .ebook-image-wrapper {
                max-width: 280px;
            }
            .ebook-content h1 {
                font-size: 1.8em;
            }
            .ebook-content p {
                font-size: 0.9em;
            }
            .ebook-btn {
                width: 200px;
                height: 50px;
                font-size: 16px;
            }
            .ebook-content {
                padding: 0.8em 1em;
                margin: 1em auto;
            }
        }

        @media screen and (max-width: 480px) {
            .ebook-landing-container {
                justify-content: flex-start;
            }
            .ebook-image-wrapper {
                max-width: 180px;
                margin-top: 2em;
            }
            .ebook-content h1 {
                font-size: 1.5em;
            }
            .ebook-content p {
                font-size: 0.8em;
            }
            .ebook-btn {
                width: 90%;
                font-size: 14px;
                height: 45px;
            }
            .ebook-content {
                padding: 0.6em 0.8em;
                margin: 0.6em auto;
            }
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.8); /* Black w/ opacity */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            backdrop-filter: blur(5px); /* Subtle blur effect */
        }

        .modal-content {
            background-color: #1a1a1a; /* Dark background matching your theme */
            margin: auto;
            padding: 30px;
            border: 1px solid #ff0077; /* Accent border */
            border-radius: 12px;
            width: 90%; /* Responsive width */
            max-width: 500px; /* Max width for larger screens */
            position: relative;
            box-shadow: 0 8px 30px rgba(255, 0, 119, 0.4); /* Glowing shadow */
            animation: fadeInModal 0.3s ease-out; /* Fade in animation */
            text-align: left; /* Align form content */
        }

        @keyframes fadeInModal {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-close {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            background: transparent;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: #ff0077;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            text-align: center;
            color: #ff0077;
            font-size: 2em;
            margin-bottom: 1.5em;
            background: transparent;
        }

        /* Payment Form Styles (inside modal) - Reused from previous step, but for modal inputs */
        .payment-form {
            width: 100%;
            margin: 0 auto; /* Center form content inside modal */
            background: transparent;
        }

        .form-group {
            margin-bottom: 1.5em;
            background: transparent;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5em;
            color: #ebebeb;
            font-size: 0.95em;
            background: transparent;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"] {
            width: calc(100% - 20px); /* Account for padding */
            padding: 12px; /* Slightly more padding for better touch input */
            border: 1px solid #ff0077;
            border-radius: 5px;
            background-color: #0d0d0d; /* Even darker input background */
            color: #ebebeb;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="tel"]:focus {
            border-color: #e00066;
            box-shadow: 0 0 8px rgba(255, 0, 119, 0.5); /* Subtle glowing effect on focus */
        }
        /* Style for the button inside the modal's form */
        .payment-form .ebook-btn {
            margin-top: 2.5em; /* Add space above the button in modal */
            width: 100%; /* Full width in modal */
        }

        /* Loader Styles */
        .loader-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1001; /* Higher than modal */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            flex-direction: column; /* To stack spinner and text */
            color: #ff0077;
            font-size: 1.2em;
        }

        .spinner {
            border: 6px solid rgba(255, 255, 255, 0.3); /* Light border */
            border-top: 6px solid #ff0077; /* Colored border for animation */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Virtual Account Modal Specific Styles */
        .virtual-account-details p {
            font-size: 1.1em;
            margin-bottom: 0.8em;
            background: transparent;
            text-align: left; /* Ensure details are left-aligned within the modal content */
        }
        .virtual-account-details strong {
            color: #ff0077;
            background: transparent;
        }
        .countdown-timer {
            font-size: 1.8em;
            font-weight: bold;
            color: #ff0077;
            margin-top: 1.5em;
            margin-bottom: 1.5em;
            background: transparent;
            text-align: center;
        }
        /* Style for copy button */
        .copy-btn {
            background-color: #555;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }
        .copy-btn:hover {
            background-color: #777;
        }
        .copy-success-message {
            display: none;
            color: #28a745; /* Green color for success */
            font-size: 0.85em;
            margin-left: 1
    </style>
</head>
<body>
    <header class="header-sec">
        <nav>
            <input type="checkbox" id="check">
            <label for="check" class="checkbtn">
                <i class="fa fa-bars"></i>
            </label>
            <a href="/" class="logo">OSA<span>YANHU</span></a>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/excelebook">Excel Functions Ebook</a></li>
                <li><a href="#" class="active">Python Programming Ebook</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Ebook Landing Content Section -->
    <section class="ebook-landing-container hero">
        <div class="ebook-image-wrapper">
            <img src="static/images/python_cover.webp"
                 alt="Introduction to Python Programming Ebook Cover"
                 class="ebook-image"
                 onerror="this.onerror=null;this.src='https://placehold.co/400x566/FCA5A5/DC2626?text=Image%20Not%20Found';"
            >
        </div>

        <div class="ebook-content">
            <h1>Learn Python, Start Coding, Boost Your Career in Nigeria!</h1>
            <p>
                Ready to break into tech or automate tasks? This "Introduction to Python Programming" ebook is your fast-track to powerful coding skills, designed specifically for beginners in Nigeria.
            </p>
            <p>
                Master <strong> fundamentals</strong>, tackle <strong> mini-projects</strong>, and build a strong foundation for Data Science, Web Development, and AI. Gain a high-demand skill and open doors to new opportunities.
            </p>

            <!-- Original Call to Action Button (now opens the form modal) -->
            <a href="javascript:void(0)"
               rel="noopener noreferrer"
               class="ebook-btn"
               id="openPaymentFormBtn"
            >
                Start Learning Python for ₦3,000!
            </a>

            <p class="secure-payment-text">
                Secure payment via Flutterwave.
            </p>
        </div>
    </section>
       <!-- Loader HTML -->
    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <p>Loading payment...</p>
    </div>
    <!-- Payment Form Modal HTML -->
    <div id="paymentFormModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2>Enter Your Details</h2>
            <form id="customerDetailsForm" class="payment-form">
                <div class="form-group">
                    <label for="modal_customer_name">Your Full Name:</label>
                    <input type="text" id="modal_customer_name" name="customer_name" placeholder="E.g., John Doe" required>
                </div>
                <div class="form-group">
                    <label for="modal_customer_email">Your Email Address:</label>
                    <input type="email" id="modal_customer_email" name="customer_email" placeholder="E.g., john.doe@example.com" required>
                </div>
                <div class="form-group">
                    <label for="modal_customer_phone">Your Phone Number:</label>
                    <input type="tel" id="modal_customer_phone" name="customer_phone" placeholder="E.g., 08012345678" required>
                </div>
                <button type="submit" class="ebook-btn">
                    Proceed to Payment
                </button>
            </form>
        </div>
    </div>

    <div id="virtualAccountModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="closeVirtualAccountModal">&times;</span>
            <h2>Complete Your Payment</h2>
            <div class="virtual-account-details">
                <p>Please transfer <strong>₦<span id="va_amount">3,000</span></strong> to the account below within:</p>
                <p class="countdown-timer" id="countdown_timer">05:00</p>

                <p>Bank Name: <strong><span id="va_bank_name">Pro-Pay Bank</span></strong></p>
                <p>
                    Account Number: <strong><span id="va_account_number">9132456789</span></strong>
                    <button class="copy-btn" data-target="va_account_number">Copy</button>
                    <span class="copy-success-message">Copied!</span>
                </p>
                <p>Account Name: <strong><span id="va_account_name">OSAYANHU EBOOKS</span></strong></p>
                
                <p style="font-size: 0.9em; opacity: 0.7; margin-top: 1.5em; text-align: center;">
                    Your payment will be automatically confirmed once we receive your transfer. You don't need to do anything else.
                </p>
            </div>
            <button id="iHaveTransferredBtn" class="ebook-btn" style="margin-top: 2em;">
                I Have Transferred (Optional)
            </button>
        </div>
    </div>
    <!-- New Modal: Purchase Success -->
    <div id="purchaseSuccessModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Payment Confirmed!</h2>
            <p style="text-align: center; font-size: 1.1em; color: #28a745;">
                Thank you for your purchase!
            </p>
            <p style="text-align: center; font-size: 0.9em; opacity: 0.7;">
                This page will refresh shortly.
            </p>
        </div>
    </div>

    <div class="footer">
        <ul class="social-icon">
            <li class="social-icon__item">
                <a class="social-icon__link" href="https://www.facebook.com/osayahnu.imoisili" target="_blank">
                    <ion-icon name="logo-facebook"></ion-icon>
                </a>
            </li>
            <li class="social-icon__item">
                <a class="social-icon__link" href="https://www.x.com/osayanhu" target="_blank">
                    <ion-icon name="logo-X"></ion-icon>
                </a>
            </li>
            <li class="social-icon__item">
                <a class="social-icon__link" href="https://www.linkedin.com/in/osayanhuimoisili" target="_blank">
                    <ion-icon name="logo-linkedin"></ion-icon>
                </a>
            </li>
            <li class="social-icon__item">
                <a class="social-icon__link" href="https://www.instagram.com/osayanhu" target="_blank">
                    <ion-icon name="logo-instagram"></ion-icon>
                </a>
            </li>
            <li class="social-icon__item">
                <a class="social-icon__link" href="https://wa.me/2348105154556/?text=Hello!" target="_blank">
                    <ion-icon name="logo-whatsapp"></ion-icon>
                </a>
            </li>
        </ul>
        <p>&copy;2025 Osayanhu Imoisili</p>
    </div>

      <!-- Loader HTML -->
    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <p>Generating your virtual account...</p>
    </div>

    <!-- IonIcons and other scripts from your home HTML -->
    <script type="module" src="https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.js"></script>
    <!-- Assuming you have all.js locally -->
    <!-- <script src="static/all.js"></script> -->

    <!-- Flutterwave Payment Integration -->
    <!-- Flutterwave SDK is NOT used for payment initiation in this virtual account flow -->
    <script>
        // --- Configuration ---
        const BACKEND_URL = 'osayanhu.vercel.app'; // IMPORTANT: Replace with your deployed backend URL
        const ZAP_WEBHOOK_URL = 'https://python-proc-713130948738.us-central1.run.app/zap/webhook';
       // --- Get HTML Elements ---
        // --- Get HTML Elements ---
        const openPaymentFormBtn = document.getElementById('openPaymentFormBtn');
        const paymentFormModal = document.getElementById('paymentFormModal');
        const closePaymentFormModalBtn = document.getElementById('closePaymentFormModal');
        const customerDetailsForm = document.getElementById('customerDetailsForm');
        const loader = document.getElementById('loader');

        const virtualAccountModal = document.getElementById('virtualAccountModal');
        const closeVirtualAccountModalBtn = document.getElementById('closeVirtualAccountModal');
        const countdownTimerDisplay = document.getElementById('countdown_timer');
        const iHaveTransferredBtn = document.getElementById('iHaveTransferredBtn');

        const vaBankName = document.getElementById('va_bank_name');
        const vaAccountNumber = document.getElementById('va_account_number');
        const vaAccountName = document.getElementById('va_account_name');
        const vaAmount = document.getElementById('va_amount');

        const purchaseSuccessModal = document.getElementById('purchaseSuccessModal'); // Get the new success modal element

        let countdownInterval; // To store the interval for the countdown timer
        let currentTxRef = ''; // To store the transaction reference for backend use
        let customerFullname = ''; // To store customer's full name from form
        let customerEmail = ''; // To store customer's email from form
        
        let pollingIntervalId; // To store the interval for polling
        let pollingAttempts = 0;
        const MAX_POLLING_ATTEMPTS = 30; // Max attempts (e.g., 30 * 7 seconds = 210 seconds = 3.5 minutes)
        const POLLING_INTERVAL_MS = 7000; // 7 seconds as requested

        // --- Event Listeners for Modals ---

        // 1. Open Customer Details Modal
        openPaymentFormBtn.addEventListener('click', function() {
            fbq('track', 'AddToCart');
            paymentFormModal.style.display = 'flex';
        });

        // 2. Close Customer Details Modal
        closePaymentFormModalBtn.addEventListener('click', function() {
            paymentFormModal.style.display = 'none';
        });

        // 3. Close Virtual Account Modal
        closeVirtualAccountModalBtn.addEventListener('click', function() {
            virtualAccountModal.style.display = 'none';
            clearInterval(countdownInterval); // Stop the countdown
            clearInterval(pollingIntervalId); // Stop polling if active
            // In a real app, you might want to trigger a final backend check here
            // or inform the user that the payment window has closed.
        });

        // Close any modal if user clicks outside of it
        window.addEventListener('click', function(event) {
            if (event.target == paymentFormModal) {
                paymentFormModal.style.display = 'none';
            }
            if (event.target == virtualAccountModal) {
                virtualAccountModal.style.display = 'none';
                clearInterval(countdownInterval); // Stop the countdown
                clearInterval(pollingIntervalId); // Stop polling if active
            }
        });

        // --- Handle Customer Details Form Submission ---
        customerDetailsForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            // Store customer details for later use (Zapier webhook)
            customerFullname = document.getElementById('modal_customer_name').value;
            customerEmail = document.getElementById('modal_customer_email').value;
            const customerPhone = document.getElementById('modal_customer_phone').value;

            // Basic validation
            if (!customerFullname || !customerEmail || !customerPhone) {
                alert("Please fill in all your details to proceed.");
                return;
            }

            // Facebook Pixel: Initiate Checkout
                fbq('track', 'InitiateCheckout');

            // Close the customer details modal
            paymentFormModal.style.display = 'none';
            // Show the loader
            loader.style.display = 'flex';
            loader.querySelector('p').textContent = 'Generating your virtual account...';

            // Generate a unique transaction reference for this attempt
            currentTxRef = "PYEBOOK_TX_" + Date.now() + "_" + Math.floor(Math.random() * 10000);

            // Prepare data as form-urlencoded (as your Flask endpoint expects request.form)
            const formData = new URLSearchParams();
            formData.append('name', customerFullname);
            formData.append('email', customerEmail);
            formData.append('phone_number', customerPhone);
            formData.append('amount', 3000); // Fixed amount for the ebook
            formData.append('tx_ref', currentTxRef);

            // --- ACTUAL API CALL TO YOUR BACKEND FOR VIRTUAL ACCOUNT CREATION ---
            try {
                const response = await fetch(`${BACKEND_URL}/api/create-virtual-account`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData.toString()
                });
                const data = await response.json(); // Parse the JSON response

                // Check for the 'error' field in the response
                if (response.ok && data.error === false) {
                    loader.style.display = 'none'; // Hide loader

                    // Populate virtual account details from the backend response
                    vaBankName.textContent = data.bankName || 'Bank Transfer'; 
                    vaAccountNumber.textContent = data.accountNumber;
                    vaAccountName.textContent = data.transferNote || 'OSAYANHU EBOOKS'; // Use transferNote for account name
                    vaAmount.textContent = parseFloat(3000).toLocaleString(); // Amount is fixed to 3000 from frontend

                    virtualAccountModal.style.display = 'flex'; // Show the virtual account modal
                    
                    // Use expiresIn from the response, which is a timestamp string ("YYYY-MM-DD HH:MM:SS")
                    // Convert to ISO format for Date object and calculate remaining seconds
                    const expirationTimeDate = new Date(data.expiresIn.replace(' ', 'T')); 
                    let remainingSeconds = Math.floor((expirationTimeDate.getTime() - Date.now()) / 1000); 
                    startCountdown(Math.max(0, remainingSeconds)); // Start countdown, ensure it's not negative

                    // Facebook Pixel: Add Payment Details
                        fbq('track', 'AddPaymentInfo');

                } else {
                    loader.style.display = 'none';
                    // Use errMsg from the error response or a generic message
                    alert(`Failed to generate virtual account. Please try again or contact support. Error: ${data.errMsg || data.message || "Unknown error"}`);
                }
            } catch (error) {
                console.error('Error creating virtual account:', error);
                loader.style.display = 'none';
                alert("An error occurred. Please check your internet connection and try again. (Check console for details)");
            }
        });

        // --- Countdown Timer Logic ---
        function startCountdown(duration) {
            let timer = duration;
            let minutes, seconds;

            clearInterval(countdownInterval); // Clear any existing interval

            countdownInterval = setInterval(() => {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                countdownTimerDisplay.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(countdownInterval);
                    virtualAccountModal.style.display = 'none'; // Close modal on expiry
                    clearInterval(pollingIntervalId); // Stop polling if timer expires
                    alert("Payment window expired. Please try again if you still wish to make payment.");
                    // In a real application, you might also trigger a backend call to invalidate
                    // the virtual account or update its status.
                }
            }, 1000);
        }

        // --- "I Have Transferred" Button Logic (Now Triggers Polling) ---
        iHaveTransferredBtn.addEventListener('click', function() {
            virtualAccountModal.style.display = 'none'; // Close the virtual account modal
            clearInterval(countdownInterval); // Stop the countdown
            
            loader.style.display = 'flex';
            loader.querySelector('p').textContent = 'Confirming your transfer...';
            pollingAttempts = 0; // Reset polling attempts

            // Start polling the backend for payment status
            pollingIntervalId = setInterval(checkPaymentStatus, POLLING_INTERVAL_MS);
            checkPaymentStatus(); // Run immediately on click
        });

        // --- Function to Poll Backend for Payment Status ---
        async function checkPaymentStatus() {
            pollingAttempts++;
            console.log(`Polling attempt ${pollingAttempts} for tx_ref: ${currentTxRef}`);

            if (pollingAttempts > MAX_POLLING_ATTEMPTS) {
                clearInterval(pollingIntervalId);
                loader.style.display = 'none';
                alert("We are still confirming your payment. This might take a bit longer. Please check your email for updates or contact support.");
                console.warn("Max polling attempts reached. Stopping polling.");
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/check-payment-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ txref: currentTxRef }) // Key is 'txref'
                });
                const data = await response.json();

                // Based on your Flask function returning txRef, flwRef, and transactionComplete
                if (response.ok && data.transactionComplete === true) {
                    clearInterval(pollingIntervalId); // Stop polling
                    loader.style.display = 'none'; // Hide loader
                    
                    // --- Send data to Zapier Webhook ---
                    // Capture transaction time as a string (ISO format is good for webhooks)
                    const transactionTime = new Date().toISOString(); 
                    sendToZapWebhook(customerEmail, customerFullname, transactionTime);

                    // --- Show Success Modal and Refresh Page ---
                    purchaseSuccessModal.style.display = 'flex'; // Show the success modal
                    
                    // Facebook Pixel: Purchase
                        fbq('track', 'Purchase', {value: 3000, currency: 'NGN'}); // Assuming ₦3000 as price
                    

                    // Refresh page after a short delay
                    setTimeout(() => {
                        window.location.reload(); // Reloads the current page
                    }, 5000); // Refresh after 5 seconds

                } else if (response.ok && data.transactionComplete === false) {
                    console.log(`Payment status for ${currentTxRef}: Not complete yet. Polling again...`);
                    loader.querySelector('p').textContent = `Confirming your transfer... (Attempt ${pollingAttempts}/${MAX_POLLING_ATTEMPTS})`;
                    // Continue polling. No alert, just log.
                } else {
                    // Handle cases where response.ok is false or unexpected data structure
                    console.error('Unexpected response from payment status check:', data);
                    loader.querySelector('p').textContent = `Verification error. Retrying... (Attempt ${pollingAttempts}/${MAX_POLLING_ATTEMPTS})`;
                }
            } catch (error) {
                console.error('Error checking payment status:', error);
                loader.querySelector('p').textContent = `Network error. Retrying... (Attempt ${pollingAttempts}/${MAX_POLLING_ATTEMPTS})`;
            }
        }

        // --- Function to send data to Zapier Webhook ---
        async function sendToZapWebhook(email, fullname, transaction_time) {
            try {
                const response = await fetch(ZAP_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        fullname: fullname,
                        transaction_time: transaction_time
                    })
                });
                if (response.ok) {
                    console.log('Data successfully sent to Zapier webhook.');
                } else {
                    console.error('Failed to send data to Zapier webhook:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error sending data to Zapier webhook:', error);
            }
        }

        // Copy button functionality for Account Number
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.dataset.target;
                const textToCopy = document.getElementById(targetId).textContent;
                
                // Use execCommand for broader iframe compatibility (or navigator.clipboard.writeText if not in iframe)
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const successMessage = this.nextElementSibling; // Get the next sibling (span for success)
                    if (successMessage) {
                        successMessage.style.display = 'inline';
                        setTimeout(() => {
                            successMessage.style.display = 'none';
                        }, 2000); // Hide after 2 seconds
                    }
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
                document.body.removeChild(textArea);
            });
        });

    </script>


    <!-- Vercel Insights/Speed Insights scripts (if you want to include them) -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js"></script>
    <script>
        window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
    </script>
    <script src="/_vercel/speed-insights/script.js"></script>
</body>
</html>
